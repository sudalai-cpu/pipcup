{% extends 'zone/base.html' %}

{% block content %}
<div class="hero-section">
    <h1 class="hero-title">Welcome to <span class="text-super">Pipcup</span></h1>
    <p class="hero-subtitle">Experience the future with our super user interface.</p>
    <div class="hero-actions">
        <button onclick="openPostModal()" class="btn-circle-floating">
            <i class="fas fa-plus"></i>
        </button>
    </div>
</div>

<!-- Create Post Modal -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closePostModal()">&times;</span>
        <h2 class="section-title" style="margin-top: 0;">Create New Post</h2>
        <form method="POST" action="{% url 'home' %}" enctype="multipart/form-data" class="post-form"
            style="margin-bottom: 0; box-shadow: none; padding: 0;">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" name="title" required class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Image</label>
                <input type="file" name="image" accept="image/*" class="form-input"
                    style="border: none; padding-left: 0;">
            </div>
            <div class="form-group">
                <label class="form-label">Content</label>
                <textarea name="content" rows="4" required class="form-input"></textarea>
            </div>
            <button type="submit" class="btn-super" style="width: 100%;">Publish Post</button>
        </form>
    </div>
</div>

<div class="post-container" style="margin-top: 20px;">
    <h2 class="section-title">Recent Posts</h2>
    <div class="posts-list">
        {% for post in posts %}
        <div class="post-card">
            <div class="post-author-header">
                <div class="author-avatar">
                    {% if post.user.profile.image %}
                    <img src="{{ post.user.profile.image.url }}" alt="{{ post.user.username }}">
                    {% else %}
                    <div class="avatar-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                    {% endif %}
                </div>
                <span class="author-username">{{ post.user.username }}</span>
            </div>
            {% if post.image %}
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="post-image">
            {% endif %}
            <div class="post-content-area">
                <h3 style="margin-top: 0;">{{ post.title }}</h3>
                <p class="post-date">{{ post.created_at|date:"F d, Y" }}</p>
                <p>{{ post.content }}</p>
            </div>
            <div class="post-actions">
                <button onclick="likePost({{ post.id }})" class="btn-like">
                    <i class="fas fa-heart"></i> <span id="like-count-{{ post.id }}">{{ post.likes }}</span>
                </button>
                <span class="action-item" onclick="openCommentModal({{ post.id }})">
                    <i class="fas fa-comment"></i>
                </span>
                <span class="action-item">
                    <i class="fas fa-share"></i>
                </span>
            </div>
        </div>
        {% empty %}
        <p>No posts yet. Be the first to post!</p>
        {% endfor %}
    </div>
</div>

<!-- Comment Modal -->
<div id="commentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeCommentModal()">&times;</span>
        <h3 class="section-title" style="margin-top: 0;">Add Comment</h3>
        <form id="commentForm" onsubmit="submitComment(event)">
            {% csrf_token %}
            <textarea id="commentContent" name="content" rows="4" class="form-input" placeholder="Write your comment..."
                required></textarea>
            <button type="submit" class="btn-super" style="margin-top: 10px; width: 100%;">Post Comment</button>
        </form>
    </div>
</div>

<script>
    function openPostModal() {
        document.getElementById('postModal').style.display = 'flex';
    }

    function closePostModal() {
        document.getElementById('postModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const postModal = document.getElementById('postModal');
        const commentModal = document.getElementById('commentModal');
        if (event.target == postModal) {
            closePostModal();
        }
        if (event.target == commentModal) {
            closeCommentModal();
        }
    }

    let currentPostId = null;

    function likePost(postId) {
        fetch(`/like/${postId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${postId}`).innerText = data.likes;
            })
            .catch(error => console.error('Error:', error));
    }

    function openCommentModal(postId) {
        currentPostId = postId;
        document.getElementById('commentModal').style.display = 'flex';
    }

    function closeCommentModal() {
        document.getElementById('commentModal').style.display = 'none';
        document.getElementById('commentContent').value = '';
        currentPostId = null;
    }

    function submitComment(event) {
        event.preventDefault();
        const content = document.getElementById('commentContent').value;
        const formData = new FormData();
        formData.append('content', content);

        // Get CSRF token from the form input
        const csrfToken = document.querySelector('#commentForm [name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`/comment/${currentPostId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    closeCommentModal();
                    alert('Comment posted successfully!');
                } else {
                    alert('Error posting comment.');
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}